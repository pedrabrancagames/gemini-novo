<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Ghostbusters AR</title>
    <meta name="description" content="Capture fantasmas que invadiram o seu mundo.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <!-- Leaflet.js (para o minimapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Estilos Gerais */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #fff;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            pointer-events: none;
        }

        .ui-element {
            pointer-events: auto;
        }

        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
            padding: 20px;
            box-sizing: border-box;
        }

        .ui-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #logo {
            width: 80%;
            max-width: 350px;
            margin-bottom: 40px;
        }

        #loading-info, #location-info-text, #distance-info {
            font-size: 1em;
            color: #ccc;
            text-align: center;
            margin-top: 20px;
            height: 20px;
        }

        .action-button {
            display: none; 
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-transform: uppercase;
        }

        #google-login-button {
            background-color: #4285F4;
            color: #fff;
        }
        
        #enter-button {
            color: #000;
            background-color: #92F428;
        }

        #enter-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* Tela de Seleção de Local */
        #location-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 350px;
        }

        .location-button {
            padding: 15px;
            background-color: #333;
            border: 2px solid #555;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .location-button.selected {
            border-color: #92F428;
            background-color: rgba(146, 244, 40, 0.2);
            transform: scale(1.05);
        }

        /* UI Principal do Jogo */
        #game-ui {
            display: none;
        }

        #top-left-logo {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 60px;
            z-index: 15;
            opacity: 0.8;
        }

        #inventory-icon-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 25;
            cursor: pointer;
        }

        #inventory-icon {
            width: 70px;
        }

        #inventory-badge {
            position: absolute;
            bottom: 5px;
            right: 0px;
            background-color: #ff0000;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            border: 2px solid white;
        }

        #proton-pack-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 90px;
            z-index: 15;
        }

        #capture-button {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            background-color: rgba(146, 244, 40, 0.3);
            border: 3px solid #92F428;
            border-radius: 50%;
            z-index: 15;
            cursor: pointer;
            overflow: hidden;
        }
        #capture-progress {
            width: 100%;
            height: 100%;
            background-color: #92F428;
            transform: translateY(100%);
            transition: transform 0.1s linear;
        }

        #minimap {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid #92F428;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 15px rgba(146, 244, 40, 0.5);
            overflow: hidden;
        }

        #distance-info {
            position: fixed;
            bottom: 180px;
            left: 20px;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            color: #92F428;
            font-weight: bold;
            z-index: 20;
        }

        /* Modal do Inventário */
        #inventory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 30;
        }

        #inventory-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: #1a1a1a;
            border: 2px solid #92F428;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(146, 244, 40, 0.5);
        }

        #inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #92F428;
        }

        #close-inventory-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        #ghost-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        #ghost-list li {
            padding: 10px;
            background: #333;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .a-enter-vr-button,
        .a-enter-ar-button {
            display: none !important;
        }
    </style>
</head>

<body>
    <a-scene id="ar-scene"
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay; overlayElement: #overlay;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true; physicallyCorrectLights: true;"
        background="color: transparent;">
        <a-assets>
            <a-asset-item id="ghost-model" src="assets/models/ghost.glb"></a-asset-item>
            <audio id="proton-beam-sound" src="assets/audio/proton-beam.mp3" preload="auto"></audio>
            <audio id="capture-success-sound" src="assets/audio/inventory_full.mp3" preload="auto"></audio>
        </a-assets>
        <a-light type="ambient" color="#FFF" intensity="0.7"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.8" position="-1 2 1"></a-light>
        <a-camera fov="80"></a-camera>
        <a-entity id="reticle" visible="false"
            geometry="primitive: ring; radius-inner: 0.04; radius-outer: 0.06;"
            material="color: #92F428; shader: flat;"></a-entity>
        <a-entity id="ghost" gltf-model="#ghost-model" visible="false"></a-entity>
    </a-scene>

    <div id="overlay">
        <div id="login-screen" class="ui-screen ui-element">
            <img id="logo" src="assets/images/logo.png" alt="Ghostbusters Logo">
            <p id="loading-info">Autenticação necessária para caçar.</p>
            <button id="google-login-button" class="action-button ui-element">Login com Google</button>
        </div>

        <div id="location-screen" class="ui-screen ui-element hidden">
            <h2>Selecione a Área de Caça</h2>
            <p id="location-info-text">Escolha um local para começar a patrulha.</p>
            <div id="location-buttons-container">
                <button class="location-button ui-element" data-location-name="Praça Central">Praça Central</button>
                <button class="location-button ui-element" data-location-name="Parque da Cidade">Parque da Cidade</button>
            </div>
            <button id="enter-button" class="action-button ui-element" disabled>Iniciar Caça</button>
        </div>

        <div id="game-ui" class="ui-element">
            <img id="top-left-logo" src="assets/images/logo.png" alt="Logo">
            <div id="inventory-icon-container" class="ui-element">
                <img id="inventory-icon" src="assets/images/ghost_trap.png" alt="Inventário">
                <div id="inventory-badge">0/5</div>
            </div>
            <img id="proton-pack-icon" src="assets/images/proton_pack.png" alt="Proton Pack">
            <div id="capture-button"><div id="capture-progress"></div></div>
            <div id="minimap"></div>
            <div id="distance-info"></div>
        </div>

        <div id="inventory-modal" class="ui-screen ui-element hidden">
            <div id="inventory-content">
                <div id="inventory-header">
                    <h2>Inventário de Fantasmas</h2>
                    <button id="close-inventory-button" class="ui-element">&times;</button>
                </div>
                <ul id="ghost-list"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            const CAPTURE_RADIUS = 15;
            const CAPTURE_DURATION = 5000;
            const INVENTORY_LIMIT = 5;

            const firebaseConfig = {
                apiKey: "AIzaSyC8DE4F6mU9oyRw8cLU5vcfxOp5RxLcgHA",
                authDomain: "ghostbusters-ar-game.firebaseapp.com",
                databaseURL: "https://ghostbusters-ar-game-default-rtdb.firebaseio.com",
                projectId: "ghostbusters-ar-game",
                storageBucket: "ghostbusters-ar-game.appspot.com",
                messagingSenderId: "4705887791",
                appId: "1:4705887791:web:a1a4e360fb9f8415be08da"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const database = getDatabase(app);
            const provider = new GoogleAuthProvider();

            const locations = {
                "Praça Central": { lat: -27.630913, lon: -48.679793 },
                "Parque da Cidade": { lat: -27.639797, lon: -48.667749 }
            };

            const sceneEl = document.getElementById('ar-scene');
            const loginScreen = document.getElementById('login-screen');
            const locationScreen = document.getElementById('location-screen');
            const enterButton = document.getElementById('enter-button');
            const googleLoginButton = document.getElementById('google-login-button');
            const gameUi = document.getElementById('game-ui');
            const locationButtons = document.querySelectorAll('.location-button');
            const minimapElement = document.getElementById('minimap');
            const distanceInfo = document.getElementById('distance-info');
            const captureButton = document.getElementById('capture-button');
            const captureProgress = document.getElementById('capture-progress');
            const inventoryIconContainer = document.getElementById('inventory-icon-container');
            const inventoryModal = document.getElementById('inventory-modal');
            const closeInventoryButton = document.getElementById('close-inventory-button');
            const inventoryBadge = document.getElementById('inventory-badge');
            const ghostList = document.getElementById('ghost-list');

            const reticle = document.getElementById('reticle');
            const ghostEntity = document.getElementById('ghost');
            const protonBeamSound = document.getElementById('proton-beam-sound');
            const captureSuccessSound = document.getElementById('capture-success-sound');

            let gameInitialized = false;
            let hitTestSource = null;
            let ghostPlaced = false;
            let currentUser = null;
            let selectedLocation = null;
            let canPlaceGhost = false;
            let isCapturing = false;
            let captureTimer, progressInterval;
            let inventory = [];

            let map, playerMarker, ghostMarker;
            let ghostPosition = {};
            let userStats = { points: 0, captures: 0 };

            function saveUserToDatabase(user) {
                const userRef = ref(database, 'users/' + user.uid);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        userStats = snapshot.val();
                        inventory = userStats.inventory || [];
                    } else {
                        const newUserStats = { displayName: user.displayName, email: user.email, points: 0, captures: 0, level: 1, inventory: [] };
                        set(userRef, newUserStats);
                        userStats = newUserStats;
                        inventory = [];
                    }
                    updateInventoryUI();
                });
            }

            function handleGoogleLogin() {
                signInWithPopup(auth, provider).catch((error) => console.error("Erro na autenticação:", error));
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    saveUserToDatabase(user);
                    loginScreen.classList.add('hidden');
                    locationScreen.classList.remove('hidden');
                } else {
                    currentUser = null;
                    loginScreen.classList.remove('hidden');
                    locationScreen.classList.add('hidden');
                    gameUi.classList.add('hidden');
                    googleLoginButton.style.display = 'block';
                }
            });

            locationButtons.forEach(button => {
                button.addEventListener('click', () => {
                    locationButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedLocation = locations[button.dataset.locationName];
                    enterButton.disabled = false;
                    enterButton.style.display = 'block';
                });
            });

            async function startARSession() {
                if (!selectedLocation) return;
                enterButton.disabled = true;
                try {
                    await sceneEl.enterAR();
                } catch (error) {
                    alert(`Erro ao iniciar AR: ${error.message}`);
                    enterButton.disabled = false;
                }
            }

            function initGame() {
                gameInitialized = true;
                locationScreen.classList.add('hidden');
                gameUi.style.display = 'block';
                initMap();
                const renderer = sceneEl.renderer;
                const xrSession = renderer.xr.getSession();
                if (xrSession) setupHitTest(xrSession, renderer);
            }

            function initMap() {
                map = L.map(minimapElement).setView([selectedLocation.lat, selectedLocation.lon], 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                generateGhost();
                startGps();
            }

            function generateGhost() {
                if (inventory.length >= INVENTORY_LIMIT) {
                    distanceInfo.innerText = "Inventário Cheio!";
                    if(ghostMarker) ghostMarker.remove();
                    return;
                }
                const radius = 0.0001;
                ghostPosition.lat = selectedLocation.lat + (Math.random() - 0.5) * radius * 2;
                ghostPosition.lon = selectedLocation.lon + (Math.random() - 0.5) * radius * 2;
                
                const ghostIcon = L.icon({ iconUrl: 'assets/images/logo.png', iconSize: [30, 30] });
                if(ghostMarker) ghostMarker.setLatLng([ghostPosition.lat, ghostPosition.lon]);
                else ghostMarker = L.marker([ghostPosition.lat, ghostPosition.lon], { icon: ghostIcon }).addTo(map);
            }

            function startGps() {
                navigator.geolocation.watchPosition(onGpsUpdate, 
                    () => { alert("Não foi possível obter sua localização."); },
                    { enableHighAccuracy: true }
                );
            }

            function onGpsUpdate(position) {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                if (!playerMarker) {
                    const playerIcon = L.divIcon({ className: 'player-marker', html: '<div style="background-color: #92F428; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>', iconSize: [15, 15] });
                    playerMarker = L.marker([userLat, userLon], { icon: playerIcon }).addTo(map);
                } else {
                    playerMarker.setLatLng([userLat, userLon]);
                }
                map.setView([userLat, userLon], map.getZoom());
                checkProximity(userLat, userLon);
            }

            function checkProximity(userLat, userLon) {
                if (inventory.length >= INVENTORY_LIMIT) return;
                const R = 6371e3;
                const phi1 = userLat * Math.PI/180, phi2 = ghostPosition.lat * Math.PI/180;
                const dPhi = (ghostPosition.lat-userLat) * Math.PI/180;
                const dLambda = (ghostPosition.lon-userLon) * Math.PI/180;
                const a = Math.sin(dPhi/2) * Math.sin(dPhi/2) + Math.cos(phi1) * Math.cos(phi2) * Math.sin(dLambda/2) * Math.sin(dLambda/2);
                const distance = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));

                distanceInfo.innerText = `Fantasma: ${distance.toFixed(0)}m`;
                if (distance <= CAPTURE_RADIUS) {
                    canPlaceGhost = true;
                    distanceInfo.innerText = "FANTASMA PRÓXIMO! OLHE AO REDOR!";
                    distanceInfo.style.color = "#ff0000";
                } else {
                    canPlaceGhost = false;
                    distanceInfo.style.color = "#92F428";
                }
            }

            function startCapture() {
                if (isCapturing || !ghostPlaced || inventory.length >= INVENTORY_LIMIT) return;
                isCapturing = true;
                protonBeamSound.play();
                let startTime = Date.now();

                progressInterval = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    const progress = Math.min(elapsedTime / CAPTURE_DURATION, 1);
                    captureProgress.style.transform = `translateY(${100 - progress * 100}%)`;
                }, 100);

                captureTimer = setTimeout(() => {
                    ghostCaptured();
                }, CAPTURE_DURATION);
            }

            function cancelCapture() {
                if (!isCapturing) return;
                isCapturing = false;
                protonBeamSound.pause();
                protonBeamSound.currentTime = 0;
                clearTimeout(captureTimer);
                clearInterval(progressInterval);
                captureProgress.style.transform = 'translateY(100%)';
            }

            function ghostCaptured() {
                cancelCapture();
                captureSuccessSound.play();
                ghostEntity.setAttribute('visible', false);
                ghostPlaced = false;
                canPlaceGhost = false;

                inventory.push({ id: Date.now(), type: 'Fantasma Comum' });
                userStats.points += 10;
                userStats.captures += 1;
                updateInventoryUI();

                const userRef = ref(database, 'users/' + currentUser.uid);
                update(userRef, { points: userStats.points, captures: userStats.captures, inventory: inventory });

                alert(`Fantasma capturado! Você agora tem ${userStats.points} pontos.`);
                generateGhost();
            }

            function updateInventoryUI() {
                inventoryBadge.innerText = `${inventory.length}/${INVENTORY_LIMIT}`;
                ghostList.innerHTML = '';
                if (inventory.length === 0) {
                    ghostList.innerHTML = '<li>Inventário vazio.</li>';
                } else {
                    inventory.forEach(ghost => {
                        const li = document.createElement('li');
                        li.textContent = ghost.type + ' - ID: ' + ghost.id;
                        ghostList.appendChild(li);
                    });
                }
            }

            async function setupHitTest(session, renderer) {
                const referenceSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: referenceSpace });
                renderer.setAnimationLoop(onXRFrame);
            }

            function onXRFrame(timestamp, frame) {
                if (!frame || !hitTestSource || ghostPlaced || !canPlaceGhost) {
                    reticle.setAttribute('visible', 'false');
                    return;
                }
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(sceneEl.renderer.xr.getReferenceSpace());
                    reticle.setAttribute('visible', true);
                    reticle.object3D.matrix.fromArray(pose.transform.matrix);
                    reticle.object3D.matrix.decompose(reticle.object3D.position, reticle.object3D.quaternion, reticle.object3D.scale);
                }
            }

            function placeGhost() {
                if (ghostPlaced || !reticle.getAttribute('visible')) return;
                ghostEntity.setAttribute('position', reticle.object3D.position);
                ghostEntity.setAttribute('visible', 'true');
                const scale = 0.3;
                ghostEntity.object3D.scale.set(scale, scale, scale);
                ghostPlaced = true;
                reticle.setAttribute('visible', 'false');
            }

            googleLoginButton.addEventListener('click', handleGoogleLogin);
            enterButton.addEventListener('click', startARSession);
            captureButton.addEventListener('mousedown', startCapture);
            captureButton.addEventListener('mouseup', cancelCapture);
            captureButton.addEventListener('mouseleave', cancelCapture);
            captureButton.addEventListener('touchstart', startCapture);
            captureButton.addEventListener('touchend', cancelCapture);
            inventoryIconContainer.addEventListener('click', () => inventoryModal.classList.remove('hidden'));
            closeInventoryButton.addEventListener('click', () => inventoryModal.classList.add('hidden'));

            sceneEl.addEventListener('enter-vr', initGame);
            sceneEl.addEventListener('click', (event) => {
                if (event.target.classList.contains('ui-element')) return;
                if (gameInitialized) placeGhost();
            });

            googleLoginButton.style.display = 'block';
        });
    </script>
</body>

</html>
